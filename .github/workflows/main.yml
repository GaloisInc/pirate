name: CI

on:
  push:
  release:
    type: [created]
jobs:
  # This task builds the HTML documentation using sphinx.
  docs:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
    - name: Build documentation
      run: |
        pip3 install sphinx
        export PATH="$HOME/.local/bin:$PATH"
        sphinx-build -M html doc build/doc
    - name: Make artifact
      uses: actions/upload-artifact@v1
      with:
        name: doc
        path: build/doc
  # This is the main build repo
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: runner
            packager: apt-get
            extra-packages: clang
            cc: clang
            extra-cmake: -DGAPS_DISABLE=ON
            sudo: sudo
          - name: standard-clang
            container: ubuntu:focal
            packager: apt-get
            extra-packages: clang wget ca-certificates cmake make git libc6-dev libssl-dev libjpeg-dev libx11-dev
            cc: clang
            extra-cmake: -DIPV6_TESTS=OFF -DGAPS_DISABLE=ON
          - name: standard-clang-shmem
            container: ubuntu:focal
            packager: apt-get
            extra-packages: clang wget ca-certificates cmake make git libc6-dev libssl-dev libjpeg-dev libx11-dev
            cc: clang
            extra-cmake: -DIPV6_TESTS=OFF -DGAPS_DISABLE=ON -DPIRATE_SHMEM_FEATURE=ON
          - name: standard-gcc
            container: ubuntu:focal
            packager: apt-get
            extra-packages: g++ wget ca-certificates cmake make git libc6-dev libssl-dev libjpeg-dev libx11-dev
            cc: gcc
            extra-cmake: -DIPV6_TESTS=OFF -DGAPS_DISABLE=ON
          - name: pirate-ubuntu
            container: docker://pirateteam/llvm-ubuntu-x86_64
            packager: apt-get
            extra-packages: wget ca-certificates git libssl-dev libjpeg-dev libx11-dev
            cc: clang
            extra-cmake: -DIPV6_TESTS=OFF
            upload-artifact: true
          - name: pirate-centos7
            container: docker://pirateteam/llvm-centos7-x86_64
            packager: yum
            cc: clang
            extra-cmake: -DIPV6_TESTS=OFF -DOPENSSL_INCLUDE_DIR=/usr/include/openssl11 -DOPENSSL_CRYPTO_LIBRARY=/usr/lib64/libcrypto.so.1.1 -DOPENSSL_SSL_LIBRARY=/usr/lib64/libssl.so.1.1
            upload-artifact: true
    runs-on: ubuntu-20.04
    container: ${{matrix.container}}
    steps:
    - uses: actions/checkout@v2
    - name: Install dependencies via apt-get
      if: matrix.packager == 'apt-get'
      run: |
        ${{matrix.sudo}} apt-get update
        ${{matrix.sudo}} DEBIAN_FRONTEND=noninteractive TZ=UTC \
           apt-get install --no-install-recommends -y \
           ${{matrix.extra-packages}} \
           valgrind libyaml-dev libavcodec-dev libavformat-dev libavutil-dev libswscale-dev
    - name: Install dependencies via yum
      if: matrix.packager == 'yum'
      run: |
        # Install epel repo
        yum install -y epel-release
        # Install git, wget, libgcc and libstdc++
        yum install -y \
           git wget cmake3 \
           devtoolset-7-gcc devtoolset-7-libstdc++-devel \
           valgrind\
           libyaml-devel-0.1.4-11.el7_0.x86_64 \
           openssl11 openssl11-devel \
           libjpeg-devel libX11-devel
        echo "/opt/rh/devtoolset-7/root/bin" >> $GITHUB_PATH
        echo "/opt/rh/llvm-toolset-7/root/bin" >> $GITHUB_PATH
        mkdir -p /root/bin
        ln -s /usr/bin/cmake3 /root/bin/cmake
        ln -s /usr/bin/openssl11 /root/bin/openssl
        echo "/root/bin" >> $GITHUB_PATH
    - name: Build googletest
      run: |
        echo "$PATH"
        mkdir ~/googletest
        cd ~/googletest
        wget -qO - https://github.com/google/googletest/archive/release-1.10.0.tar.gz | tar -xz
        cmake -D CMAKE_INSTALL_PREFIX:PATH=$HOME/googletest -D CMAKE_BUILD_TYPE=Release googletest-release-1.10.0
        cmake --build . --target install
    # We can only install the Mercury loopback on the non-docker builds.
    - name: Build and install Mercury loopback
      if: matrix.name == 'runner'
      run: |
        cd devices/mercury/loopback_ilip
        make
        sudo insmod gaps_ilip.ko
        test -c /dev/gaps_ilip_0_root || exit 1
    - name: Build libpirate
      run: |
        mkdir -p build
        cd build
        cmake -DCMAKE_C_COMPILER=${{matrix.cc}} \
              ${{matrix.extra-cmake}} \
              -DCMAKE_INSTALL_PREFIX=../${{matrix.name}}-libs/libpirate \
              -DGTEST_ROOT:PATH=$HOME/googletest \
              -DPIRATE_UNIT_TEST=ON \
              -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON  \
              -DPIRATE_LAUNCHER=OFF \
              -DPIRATE_GETOPT=OFF \
              ..
        make
        make install
    - name: Build Launcher
      run: |
        mkdir -p build-pal
        cd build-pal
        CFLAGS="-I$GITHUB_WORKSPACE/${{matrix.name}}-libs/libpirate/include" \
          LDFLAGS="-L$GITHUB_WORKSPACE/${{matrix.name}}-libs/libpirate/lib" \
          cmake -DCMAKE_C_COMPILER=${{matrix.cc}} \
                ${{matrix.extra-cmake}} \
                -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/${{matrix.name}}-libs/pal \
                ../pal
        make install
    - name: Build libpirategetopt
      run: |
        mkdir -p build-getopt
        cd build-getopt
        cmake -DCMAKE_C_COMPILER=${{matrix.cc}} \
              ${{matrix.extra-cmake}} \
              -DCMAKE_INSTALL_PREFIX=../${{matrix.name}}-libs/libpirategetopt \
              ../libpirategetopt
        make install
      # We put the libraries in a tarball so we can preserve symbolic links.
    - name: Make library tar
      if: matrix.upload-artifact
      run: tar cvfz ${{matrix.name}}-libs.tgz ${{matrix.name}}-libs
    - name: Make library artifact
      uses: actions/upload-artifact@v1
      if: matrix.upload-artifact
      with:
        name: ${{matrix.name}}-libs
        path: ${{matrix.name}}-libs.tgz
    - name: libpirate tests
      timeout-minutes: 5
      run: |
        cd build/libpirate
        ./gaps_channels_test
        make valgrind
    - name: build benchmarks
      run: |
        cd build
        cmake -DCMAKE_C_COMPILER=${{matrix.cc}} \
              ${{matrix.extra-cmake}} \
              -DGAPS_BENCH=ON \
              -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON ..
        make
    - name: build demos
      run: |
        cd build
        cmake -DGAPS_DEMOS=ON \
              ${{matrix.extra-cmake}} \
              -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON ..
        make
    - name: time_demo tests
      run: |
        cd build/demos/time_demo/test
        ./ts_test.sh
  windows-build:
    runs-on: windows-2019
    steps:
    - uses: actions/checkout@v2
    - name: googletest
      shell: powershell
      run: |
        mkdir ~/googletest
        cd ~/googletest
        Invoke-WebRequest -Uri https://github.com/google/googletest/archive/release-1.10.0.tar.gz -MaximumRedirection 10 -OutFile release-1.10.0.tar.gz
        tar -x -z -f release-1.10.0.tar.gz
        cd googletest-release-1.10.0
        mkdir build
        cd build
        cmake ..
        cmake --build . --config Release --target install
    - name: build libpirate
      run: |
        mkdir build
        cd build
        cmake -DGTEST_LIBRARY="C:\\Program Files (x86)\\googletest-distribution\\lib\\gtest.lib" `
          -DGTEST_MAIN_LIBRARY="C:\\Program Files (x86)\\googletest-distribution\\lib\\gtest_main.lib" `
          -DGTEST_INCLUDE_DIR="C:\\Program Files (x86)\\googletest-distribution\\include" `
          -DGAPS_DISABLE=ON `
          -DPIRATE_UNIT_TEST=ON `
          -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON `
          -DPIRATE_LAUNCHER=OFF `
          -DPIRATE_GETOPT=OFF `
          ..
        cmake --build . --config Release
    - name: libpirate tests
      timeout-minutes: 5
      run: |
        cd build/libpirate/Release
        ./gaps_channels_test.exe
  # This assembles a tar with all artifacts.
  assemble-tar:
    needs: [docs, build]
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: pirate-ubuntu
            packager: apt-get
            container: docker://pirateteam/llvm-ubuntu-x86_64
          - name: pirate-centos7
            packager: yum
            container: docker://pirateteam/llvm-centos7-x86_64
    runs-on: ubuntu-20.04
    container: ${{matrix.container}}
    steps:
    - name: Install dependencies via apt-get
      if: matrix.packager == 'apt-get'
      run: |
        apt-get update
        DEBIAN_FRONTEND=noninteractive TZ=UTC \
        apt-get install --no-install-recommends -y \
          ca-certificates curl apt-transport-https lsb-release gnupg
        # Download and install the Microsoft signing key:
        curl -sL https://packages.microsoft.com/keys/microsoft.asc |
          gpg --dearmor |
          tee /etc/apt/trusted.gpg.d/microsoft.gpg > /dev/null
        # Add the Azure CLI software repository
        AZ_REPO=$(lsb_release -cs)
        echo "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $AZ_REPO main" > /etc/apt/sources.list.d/azure-cli.list
        # Install azure-cli
        apt-get update
        DEBIAN_FRONTEND=noninteractive TZ=UTC \
          apt-get install --no-install-recommends -y azure-cli
    - name: Install dependencies via yum
      if: matrix.packager == 'yum'
      run: |
        # Import the Microsoft repository key
        rpm --import https://packages.microsoft.com/keys/microsoft.asc
        # Create local azure-cli repository information
        cat << EOF > /etc/yum.repos.d/azure-cli.repo
        [azure-cli]
        name=Azure CLI
        baseurl=https://packages.microsoft.com/yumrepos/azure-cli
        enabled=1
        gpgcheck=1
        gpgkey=https://packages.microsoft.com/keys/microsoft.asc
        EOF
        ls -l /etc/yum.repos.d
        # Install git, wget, libgcc and libstdc++
        yum install -y azure-cli
    - name: Get libraries
      uses: actions/download-artifact@v1
      with:
        name: ${{matrix.name}}-libs
        path: ${{matrix.name}}-libs.tgz
    - name: Get documentation
      uses: actions/download-artifact@v1
      with:
        name: doc
        path: doc
    - name: Make archive
      run: |
        tar xvfz ${{matrix.name}}-libs.tgz
        mkdir -p ${{matrix.name}}/bin
        
        cd ${{matrix.name}}/bin
        # Add clang-pirate
        cp -a /usr/local/bin/clang-10 clang-pirate
        ln -s clang-pirate clang
        ln -s clang clang-cl
        ln -s clang clang-cpp
        ln -s clang cc
        ln -s clang-pirate clang++
        ln -s clang++ c++
        # Add lld-pirate
        cp -a /usr/local/bin/lld lld-pirate
        ln -s lld-pirate ld.lld-pirate
        ln -s lld-pirate ld
        cd ../..
        
        cp -a ${{matrix.name}}-libs/libpirate/include ${{matrix.name}}
        cp -a ${{matrix.name}}-libs/libpirate/lib     ${{matrix.name}}
        cp -a doc/html ${{matrix.name}}/doc

        tar cvfz ${{matrix.name}}.tgz ${{matrix.name}}
    - name: Make artifact
      uses: actions/upload-artifact@v1
      with:
        name: ${{matrix.name}}
        path: ${{matrix.name}}.tgz
    - name: Upload distribution
      if: github.ref == 'master'
      run: |
        az storage blob upload \
          --account-name pirateteam \
          --account-key ${{ secrets.AZURE_ACCOUNT }} \
          -c \$web \
          -f ${{matrix.name}}.tgz \
          -n dist/${{matrix.name}}.tgz
  assemble-docker-images:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu
            libname: pirate-ubuntu-libs
            imagedir: images/ubuntu
            dockername: pirateteam/ubuntu
          - name: centos7
            libname: pirate-centos7-libs
            imagedir: images/centos7
            dockername: pirateteam/centos7
    runs-on: ubuntu-20.04
    needs: [build]
    steps:
    - uses: actions/checkout@v2
    - name: Get libpirate
      uses: actions/download-artifact@v1
      with:
        name: ${{matrix.libname}}
        path: ${{matrix.libname}}
    - name: Build pirateteam/ubuntu
      run: |
        tar xvfz ${{matrix.libname}}.tgz
        cp -a ${{matrix.libname}}/libpirate       ${{matrix.imagedir}}
        cp -a ${{matrix.libname}}/libpirategetopt ${{matrix.imagedir}}
        cp -a ${{matrix.libname}}/pal             ${{matrix.imagedir}}
        docker build -t ${{matrix.dockername}} ${{matrix.imagedir}}
        docker save ${{matrix.dockername}} | gzip > ${{matrix.name}}-docker.tar.gz
    - name: Make pirateteam/ubuntu artifact
      uses: actions/upload-artifact@v1
      with:
        name: ${{matrix.name}}-docker
        path: ${{matrix.name}}-docker.tar.gz
    - name: Build demos on docker image
      run: |
        mkdir -p build
        # Run cmake
        docker run --mount type=bind,src=`pwd`/build,dst=/root/build \
                   --mount type=bind,src=`pwd`/demos,dst=/root/demos,readonly \
                   -w /root/build \
                   ${{matrix.dockername}} \
                   cmake ../demos
        # Run make
        docker run --mount type=bind,src=`pwd`/build,dst=/root/build \
                   --mount type=bind,src=`pwd`/demos,dst=/root/demos,readonly \
                   -w /root/build \
                   ${{matrix.dockername}} \
                   make
    - name: Post docker images
      run: |
        echo ${{ secrets.docker_password }} | docker login -u gapspirateteam --password-stdin
        docker push ${{matrix.dockername}}:${{ github.event.release.tag_name }}
      if: github.event_name == 'release'
  # This builds the IDL tool
  antlr-idl:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: install dependencies
      run: |
        sudo sed -i 's/azure.archive.ubuntu.com/us.archive.ubuntu.com/g' /etc/apt/sources.list
        sudo apt-get update
        sudo apt-get install --no-install-recommends -y clang valgrind libyaml-dev uuid-dev default-jre-headless
    - name: googletest
      run: |
        mkdir ~/googletest
        cd ~/googletest
        wget -qO - https://github.com/google/googletest/archive/release-1.10.0.tar.gz | tar -xz
        cmake -D CMAKE_INSTALL_PREFIX:PATH=$HOME/googletest -D CMAKE_BUILD_TYPE=Release googletest-release-1.10.0
        cmake --build . --target install
    - name: Cache antlr4 runtime
      id: cache-antlr4-runtime
      uses: actions/cache@v2
      env:
        cache-name: cache-antlr4.8-runtime
      with:
        path: ~/antlr4
        key: ${{ runner.os }}-build-${{ env.cache-name }}
    - name: Build antlr4 runtime
      if: steps.cache-antlr4-runtime.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/antlr4
        cd ~/antlr4
        wget -qO - https://www.antlr.org/download/antlr-4.8-complete.jar > antlr-4.8-complete.jar
        wget -qO - https://www.antlr.org/download/antlr4-cpp-runtime-4.8-source.zip > antlr4-cpp-runtime-4.8-source.zip
        unzip antlr4-cpp-runtime-4.8-source.zip
        mkdir build
        cd build
        cmake -D ANTLR4_INSTALL=1 ..
        make
    - name: Install antlr4 runtime
      run: |
        cd ~/antlr4/build
        sudo make install
        cd ..
    - name: Build idl
      run: |
        cd antlr
        mkdir -p build
        cd build
        cmake -DGTEST_ROOT:PATH=$HOME/googletest \
              -DPIRATE_UNIT_TEST=ON \
              -DANTLR4_MODULE_PATH=/usr/local/lib/cmake/antlr4 \
              -DANTLR4_JAR_LOCATION=$HOME/antlr4/antlr-4.8-complete.jar \
              -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON \
              ..
        make
        ./idl_test
        make valgrind
  # This builds the VSCode plugins
  vscode-plugins:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
    - name: Install npm
      run: |
        sudo apt-get update
        sudo apt-get install --no-install-recommends -y npm
    - name: Install vsce
      run: sudo npm install -g --no-optional vsce
    - name: Install dependencies
      working-directory: vscode-plugins/architecture
      run: npm install
    - name: Package extension
      working-directory: vscode-plugins/architecture
      run: vsce package
