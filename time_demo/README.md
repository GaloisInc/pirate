# Trusted Timestamp Example

## Overview
A detailed description of the Trusted Timestamp demo is provided
[here](https://github.com/GaloisInc/pirate-annotations/blob/master/spec/timestamp_demo.rst).
The purpose of this README is to document implementation, testing, and execution
of the Trusted Timestamp demo components.

## Building
All demo components are built by following instructions provided
[in the main project README](https://github.com/GaloisInc/pirate-demos/blob/master/README.md).
* The build process generates PKI components, which include creation of two
  private/public key pairs. On a machine with limited resources this step may
  take a noticeable amount of time.
* To build time demo with serial GAPS channels between the proxy and the signing
  service, use ```cmake .. -DGAPS_SERIAL=ON```
* All build artifacts are located in ```build/time_demo``` directory

### Dependencies
* [libpirate](https://github.com/GaloisInc/pirate-demos/tree/master/libpirate)
* [OpenSSL](https://www.openssl.org/)
* [Valgrind](https://valgrind.org/)

## Implementation
All three demo components are based on common code for configuring and managing
GAPS channels as well as work thread creation and termination. Sections of code
for GAPS channel management will be replaced with code generated by the
compiler when GAPS source annotations became available.

Timestamp cryptography code is based on OpenSSL's support for
[RFC3161](https://tools.ietf.org/html/rfc3161) Time-Stamp Protocol (TSP) and is
located in the ```ts_crypto.c``` source file. All data structures for storing
requests and responses are designed to be agnostic to cryptographic algorithms
behind the implementation.

### Verbosity
By default all demo components run in a quiet mode. Use ```-v``` to increase
output verbosity.
- ```-v``` displays event messages
- ```-v``` or ```-vv``` displays event messages and parsed request/response
 structure components. __NOTE__ this level of verbosity is mainly used for
 debugging.

### Usage
All application binaries support help and usage options:
- ```<application binary> --help```
- ```<application binary> --usage```

#### Sensor Manager (Trusted Timestamp Client)
```
Usage: sensor_manager [OPTION...] [FILE] [FILE] ...
Sign files with the trusted timestamp service

  -C, --ca_path=PATH         CA Path
  -d, --req_delay=MS         Request delay in milliseconds
  -s, --save_path=PATH       TSR output directory
  -v, --verbose              Increase verbosity level
  -V, --verify               Verify timestamp signatures
  -?, --help                 Give this help list
      --usage                Give a short usage message
      --version              Print program version
```

#### Signing Proxy
```
Usage: signing_proxy [OPTION...]
Proxy between the client and timestamp signing service

  -p, --period=MS            Request polling period
  -q, --queue-len=LEN        Request queue length
  -v, --verbose              Increase verbosity level
  -?, --help                 Give this help list
      --usage                Give a short usage message
  -V, --version              Print program version
```

#### Trusted Timestamp Service
```
Usage: signing_service [OPTION...]
Timestamp signing service

  -c, --conf=PATH            Configuration file path
  -s, --conf_sect=SECTION    Configuration section
  -v, --verbose              Increase verbosity level
  -?, --help                 Give this help list
      --usage                Give a short usage message
  -V, --version              Print program version
```

#### Trusted Timestamp Cryptography Test
```
Usage: ts_test [OPTION...] [FILE] [FILE] ...
Generate TS request, TS sign, and TS validate test

  -c, --config=PATH          Configuration file
  -C, --ca_path=PATH         CA Path
  -n, --loops=ITERATIONS     Number of test iterations
  -s, --section=SECTION      Configuration TSA section
  -v, --verbosity            Increase verbosity level
  -?, --help                 Give this help list
      --usage                Give a short usage message
  -V, --version              Print program version
```

## Directory Structure

### Source, Configuration, and Scripts
The build processes copies configuration resources into appropriate output
build directories. An attempt to run scripts from the `scripts` directory will
likely result in an error.
```
time_demo
├── conf
│   └── OpenSSL configuration resources
├── include
│   └── Trusted Timestamp Demo headers
├── scripts
│   └── Test and launch scripts
└── src
    └── Trusted Timestamp Demo sources
```

### Output Directory
The output directory and its components are auto-generated by the build process.
```
time_demo
├── ca
    ├── priv
    │   │   └── tsa_ca_key.pem         Certificate authority private key
    │   └── tsa_ca.pem                 Certificate authority certificate
    ├── high
    │   ├── sensor_manager             Timestamp client application binary
    │   └── signing_proxy              Timestamp proxy application binary
    └── low
        ├── pki
        │   ├── priv
        │   │   ├── tsa_key.pem        Timestamp service private
        │   │   └── tsa_req.pem        Timestamp service CA sign request
        │   ├── tsa_cert.pem           Timestamp service certificate
        │   └── tsa.conf               Timestamp service configuration file
        ├── signing_service            Timestamp service application binary
        ├── ts_test                    Timestamp cryptography unit test binary
        └── ts_test.sh                 Timestamp cryptography memory test script
```

## Testing
Trusted timestamp sequence of
```
[Proxy Request] -> [Timestamp Request] -> [Timestamp Sign] -> [Timestamp Verify]
```
is tested in a standalone application ```low/ts_test```.

```low/ts_test.sh``` script executes the test application under different levels of
verbosity and checks for memory leaks and errors.

## Setup

### Applying udev rules
In order to avoid ambiguity of ```/dev/ttyUSB*``` device assignment, a udev
rules file was added to generate symbolic links for pre-configured USB to serial
devices.
```
$ cd time_demo/scripts
$ ./add_udev_rules.sh
```
__NOTE__ ___sudo___ privileges are required for this task

### Adding a new USB serial device
Determine __vendor id__, __product id__, and __serial number__ of the device:
```
$ lsusb
...
Bus 001 Device 005: ID 0403:6001 Future Technology Devices International, Ltd FT232 USB-Serial (UART) IC
...

$ sudo lsusb -v -d 0403:6001 | grep iSerial
  iSerial                 3 AC018LUP
```
__NOTE__ The last command will run successfully without ___sudo___, however, the
serial number will not be fetched.

Add a new entry to the ```gaps.rules``` file
```
SUBSYSTEMS=="usb", KERNEL=="ttyUSB*", ATTRS{idVendor}=="0403", ATTRS{idProduct}=="6001", ATTRS{serial}=="AC018LUP", SYMLINK+="<name>"
```
Apply updated udev rules by following instructions in the section above

__NOTE__ not all USB to serial devices provide a valid serial number, however, [this](https://www.amazon.com/gp/product/B07589ZF9X/ref=ppx_yo_dt_b_asin_title_o00_s00?ie=UTF8&psc=1) device does.

### Add the current user to the __dialout__ group
```
$ sudo usermod -a -G dialout <user_name>
```
__NOTE__ technically this step is not needed as long as time demo binaries are
executed with ___sudo___ privileges.

### Serial Connection
A serial [null modem](https://en.wikipedia.org/wiki/Null_modem) is required.

## Troubleshooting
### GAPS Serial Device Fails to Open
* Verify that the symbolic link is present ```ls /dev/tty_*```
* Verify that the user has privileges to open the device

### Serial Data is Corrupted
* Unplug and plug back in USB to serial converters
* Run UART stress test located in ```build/time_demo/low```
* Reduce the baud rate. Note this change requires editing of ```libpirate/test/serial_test.c``` and re-compilation
* Use a different USB to serial device

### Time Signature Fails Validation
* Make sure that the time service is configured with proper PKI. This issue may occur when timestamp signing service was compiled independently on a separate machine. Instead of building time stamp service, copy ```pki``` and ```low``` directories to the target machine.
* Make sure that system time is set correctly.

## Outstanding Tasks
- Add and test GAPS annotations
- Add a worker thread in signing proxy for sending back client replies. This
  step may be needed to monotonize proxy to service request period if
  transmission of a timestamp response over a GAPS channel takes a measurable
  amount of time
- Improve unit tests by adding proper test build targets
